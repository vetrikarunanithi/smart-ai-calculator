<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart AI Calculator</title>
    <meta
      name="description"
      content="A modern calculator web app powered by Flask and JavaScript. Performs real-time calculations with a clean UI and history tracking."
    />
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  </head>
  <body>
    <div class="main-container">
      <div class="calculator-card">
        <div class="display-section">
          <div class="equation-display" id="equation"></div>
          <div class="main-display-wrapper">
            <input
              type="text"
              class="main-display"
              id="display"
              value="0"
              readonly
            />
          </div>
        </div>

        <div id="loading" class="loading-spinner" style="display: none">
          <div class="spinner"></div>
          <span>Calculating...</span>
        </div>

        <div class="button-grid">
          <!-- Row 1 -->
          <button class="btn-clear" onclick="clearAll()">C</button>
          <button class="btn-function" onclick="toggleSign()">+/-</button>
          <button class="btn-function" onclick="handlePercentage()">%</button>
          <button class="btn-operator" onclick="setOperator('/')">Ã·</button>

          <!-- Row 2 -->
          <button class="btn-number" onclick="appendValue('7')">7</button>
          <button class="btn-number" onclick="appendValue('8')">8</button>
          <button class="btn-number" onclick="appendValue('9')">9</button>
          <button class="btn-operator" onclick="setOperator('*')">Ã—</button>

          <!-- Row 3 -->
          <button class="btn-number" onclick="appendValue('4')">4</button>
          <button class="btn-number" onclick="appendValue('5')">5</button>
          <button class="btn-number" onclick="appendValue('6')">6</button>
          <button class="btn-operator" onclick="setOperator('-')">-</button>

          <!-- Row 4 -->
          <button class="btn-number" onclick="appendValue('1')">1</button>
          <button class="btn-number" onclick="appendValue('2')">2</button>
          <button class="btn-number" onclick="appendValue('3')">3</button>
          <button class="btn-operator" onclick="setOperator('+')">+</button>

          <!-- Row 5 -->
          <button class="btn-number btn-span-2" onclick="appendValue('0')">
            0
          </button>
          <button class="btn-number" onclick="appendDecimal()">.</button>
          <button class="btn-equals" onclick="calculate()">=</button>
        </div>

        <button class="delete-button" onclick="deleteDigit()">
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path>
            <line x1="18" y1="9" x2="12" y2="15"></line>
            <line x1="12" y1="9" x2="18" y2="15"></line>
          </svg>
          <span>Delete</span>
        </button>

        <button class="btn-ai btn-span-2" onclick="explainAI()">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="icon-ai"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path
              d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"
            ></path>
            <circle cx="12" cy="12" r="4"></circle>
          </svg>
          <span>Explain with AI</span>
        </button>
      </div>

      <div id="ai-explanation" class="ai-box" style="display: none"></div>

      <div class="history-container" id="historyContainer">
        <div class="history-header">
          <div class="history-title">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M3 3v5h5M3.05 13A9 9 0 1 0 6 5.3L3 8"></path>
            </svg>
            History
          </div>
          <button class="clear-history-btn" onclick="clearHistory()">
            Clear
          </button>
        </div>
        <div class="history-items" id="historyItems"></div>
      </div>

      <footer class="footer">
        <p>Smart AI Calculator v1.0</p>
        <p>Developed by <strong>Vetriselvan Karunanithi</strong></p>
      </footer>
    </div>

    <script>
      // Get display and history elements
      const display = document.getElementById("display");
      const historyContainer = document.getElementById("historyContainer");
      const historyItems = document.getElementById("historyItems");

      let expression = ""; // Stores full input (like 8+8+8/2)
      let history = []; // Stores past calculations

      // Add number or operator to display
      function appendValue(value) {
        if (display.value === "0") {
          display.value = value;
        } else {
          display.value += value;
        }
        expression = display.value;
      }

      // Add a decimal point
      function appendDecimal() {
        // Get the current expression part after the last operator
        const parts = display.value.split(/[\+\-\*\/]/);
        const currentPart = parts[parts.length - 1];

        // Allow decimal only if the current number doesn't already have one
        if (!currentPart.includes(".")) {
          display.value += ".";
          expression = display.value;
        }
      }

      // Clear display and reset
      function clearAll() {
        display.value = "0";
        expression = "";
      }

      // Delete last character
      function deleteDigit() {
        display.value = display.value.slice(0, -1);
        if (display.value === "") {
          display.value = "0";
        }
        expression = display.value;
      }

      // Change sign (+/-)
      function toggleSign() {
        if (display.value.startsWith("-")) {
          display.value = display.value.substring(1);
        } else {
          display.value = "-" + display.value;
        }
        expression = display.value;
      }

      // Convert to percentage
      function handlePercentage() {
        display.value = (parseFloat(display.value) / 100).toString();
        expression = display.value;
      }

      // Send expression to backend for calculation
      async function calculate() {
        if (expression === "") return;

        const loadingText = document.getElementById("loading");
        loadingText.style.display = "block"; // show loading text

        try {
          const response = await fetch("http://127.0.0.1:5000/calculate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ expression: expression }),
          });

          const data = await response.json();
          loadingText.style.display = "none"; // hide loading

          if (response.ok && data.result !== undefined) {
            const result = data.result;
            const fullEquation = `${expression} = ${result}`;
            display.value = result;
            expression = result.toString();
            addToHistory(fullEquation);
          } else {
            display.value = data.error || "Error";
            setTimeout(clearAll, 2000);
          }
        } catch (error) {
          loadingText.style.display = "none"; // ensure hides on error
          display.value = "Connection Error";
          setTimeout(clearAll, 2000);
        }
      }

      // Add item to history
      function addToHistory(item) {
        history.unshift(item);
        if (history.length > 5) history.pop();
        updateHistory();
      }

      // Update history section
      function updateHistory() {
        if (history.length === 0) {
          historyContainer.classList.remove("show");
          return;
        }
        historyContainer.classList.add("show");
        historyItems.innerHTML = history
          .map((item) => `<div class="history-item">${item}</div>`)
          .join("");
      }

      // Clear history
      function clearHistory() {
        history = [];
        updateHistory();
      }

      // Operator buttons (+, -, *, /)
      function setOperator(op) {
        display.value += op;
        expression = display.value;
      }

      // AI Explain function
      async function explainAI() {
        if (expression.trim() === "") return;

        const aiBox = document.getElementById("ai-explanation");
        aiBox.style.display = "block";
        aiBox.classList.add("show");
        aiBox.textContent = "ðŸ¤” Thinking...";

        try {
          const response = await fetch("http://127.0.0.1:5000/explain", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ expression: expression }),
          });

          const data = await response.json();
          aiBox.innerHTML = marked.parse(data.explanation || "No explanation available.");
          aiBox.classList.add("active");
        } catch (error) {
          aiBox.textContent = "Error connecting to AI service.";
        }
      }

      // Allow keyboard input
      document.addEventListener("keydown", (e) => {
        const key = e.key;

        if (!isNaN(key)) appendValue(key); // numbers
        else if (["+", "-", "*", "/"].includes(key)) setOperator(key);
        else if (key === "Enter" || key === "=") calculate();
        else if (key === "Backspace") deleteDigit();
        else if (key === ".") appendDecimal();
        else if (key.toLowerCase() === "c") clearAll();
      });
    </script>
  </body>
</html>
